<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Input Nilai ATS - Malika IBS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* Dark mode base */
            color: #e0e0e0; /* Light grey text */
            overflow-x: hidden;
        }
        
        .running-text-container {
            width: 100%;
            background-color: #007AFF; /* Biru terang solid */
            color: #FFFFFF; /* Teks warna putih */
            font-weight: 500;
            overflow: hidden;
            position: fixed;
            bottom: 0;
            left: 0;
            z-index: 50;
        }
        .running-text p {
            margin: 0;
            padding: 8px 0;
            white-space: nowrap;
            display: inline-block;
            animation: marquee 35s linear infinite; /* Sedikit diperlambat untuk teks yang lebih panjang */
        }
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #4a4a4a; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6a6a6a; }
        
        /* Remove number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* Custom Card Style for Dark Mode */
        .card {
            background-color: rgba(29, 29, 31, 0.7); /* Darker background with transparency */
            backdrop-filter: blur(8px);
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08); /* Subtle white border */
            transition: all 0.3s ease-in-out;
            color: #e0e0e0;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.15), 0 8px 10px -6px rgb(0 0 0 / 0.08);
        }
        
        /* Professional Buttons for Dark Mode */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600; /* Slightly less bold for modern look */
            color: white;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            border: none;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .btn-primary {
            background-image: linear-gradient(135deg, #007AFF, #005AF0); /* Blue gradient, more prominent */
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.2), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .btn-primary:disabled {
            background-image: none;
            background-color: #333333;
            color: #888888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-secondary {
            background-image: linear-gradient(135deg, #34C759, #28A745); /* Green gradient */
        }
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.2), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        
        /* Input field styling for dark mode */
        select, input.grade-input {
            background-color: rgba(50, 50, 50, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #e0e0e0;
        }
        select:focus, input.grade-input:focus {
            border-color: #007AFF;
            ring-color: #007AFF;
        }
        
        /* Gradient Text */
        .gradient-text-apple {
            background: linear-gradient(to right, #5AC8FA, #BF5AF2, #FF2D55);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .gradient-text-blue {
            background: linear-gradient(to right, #007AFF, #5AC8FA);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Table header for dark mode */
        .table-header-dark {
            background-color: #1a1a1a;
            color: #ffffff;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .table-row-dark {
            background-color: rgba(29, 29, 31, 0.5);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .table-row-dark:hover {
            background-color: rgba(40, 40, 42, 0.6);
        }

        /* Modal specific dark styles */
        #preview-modal .bg-white { /* Target modal content */
            background-color: rgba(29, 29, 31, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
        }
        #preview-modal .p-6.border-b {
            border-color: rgba(255, 255, 255, 0.1);
        }
        #preview-modal .bg-slate-50 {
            background-color: rgba(29, 29, 31, 0.8);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Toast for dark mode */
        #toast {
            background-color: rgba(255, 255, 255, 0.15); /* Semi-transparent white */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ffffff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
    </style>
</head>
<body class="pb-20">
    
    <!-- Main Container --><div class="container mx-auto p-4 md:p-8 max-w-7xl relative z-10">
        
        <!-- Header --><header class="bg-black/40 backdrop-blur-lg rounded-xl shadow-md p-6 mb-8 flex flex-col md:flex-row items-center gap-6 border border-white/10">
            <img src="https://iili.io/FsLlXA7.png" alt="Logo Malika Islamic Boarding School" class="h-20 w-20 rounded-full object-cover border-2 border-white/20">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-white mb-1">
                    Sistem <span class="gradient-text-apple">Input Nilai ATS</span>
                </h1>
                <p class="text-white/70 text-lg">Malika Islamic Boarding School</p>
            </div>
        </header>

        <!-- Step 1: Selection Form --><div id="selection-form" class="card p-8 transition-all duration-300">
            <h2 class="text-xl font-bold mb-6 border-b border-white/10 pb-3 text-white">1. Pilih Detail Kelas</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="school-level" class="block text-sm font-medium text-white/80 mb-2">Jenjang Sekolah</label>
                    <select id="school-level" class="w-full p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        <option value="">Pilih Jenjang...</option>
                        <option value="SMP">SMP</option>
                        <option value="SMA">SMA</option>
                    </select>
                </div>
                <div>
                    <label for="class-name" class="block text-sm font-medium text-white/80 mb-2">Kelas</label>
                    <select id="class-name" class="w-full p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" disabled>
                        <option>Pilih Jenjang Dulu</option>
                    </select>
                </div>
                <div>
                    <label for="subject" class="block text-sm font-medium text-white/80 mb-2">Mata Pelajaran</label>
                    <select id="subject" class="w-full p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" disabled>
                        <option>Pilih Jenjang Dulu</option>
                    </select>
                </div>
            </div>
            <div class="mt-8 text-right">
                <button id="start-input-btn" class="btn btn-primary" disabled>
                    Mulai Input Nilai &rarr;
                </button>
            </div>
        </div>

        <!-- Step 2: Grade Input Table --><div id="grade-input-section" class="card p-8 mt-8 hidden transition-all duration-300">
            <div class="flex justify-between items-start mb-6 border-b border-white/10 pb-3">
                <div>
                    <h2 class="text-xl font-bold text-white">2. Input Nilai Santri</h2>
                    <p id="grade-input-header" class="text-white/70"></p>
                </div>
                <button id="change-selection-btn" class="text-sm font-semibold gradient-text-blue hover:opacity-80">Ubah Pilihan</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full min-w-full text-sm text-left text-white/80">
                    <thead class="text-xs uppercase table-header-dark">
                        <tr>
                            <th scope="col" class="px-6 py-3 rounded-l-lg w-16">No.</th>
                            <th scope="col" class="px-6 py-3">Nama Santri</th>
                            <th scope="col" class="px-6 py-3 rounded-r-lg text-center">Nilai (10-100 atau -)</th>
                        </tr>
                    </thead>
                    <tbody id="student-list-body"></tbody>
                </table>
            </div>
            <div class="mt-8 text-right">
                <button id="preview-btn" class="btn btn-secondary">
                    Preview Nilai
                </button>
            </div>
        </div>

    </div>

    <!-- Modal for Preview and Confirmation --><div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col transform transition-all scale-95 opacity-0 duration-300">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-white">Konfirmasi Input Nilai</h3>
                <button id="close-modal-btn" class="text-white/50 hover:text-white text-3xl">&times;</button>
            </div>
            <div class="p-8 overflow-y-auto">
                <div id="preview-details" class="mb-6 space-y-2 text-white/90"></div>
                <div class="overflow-x-auto border rounded-lg border-white/10">
                    <table class="w-full text-sm text-left text-white/80">
                        <thead class="text-xs uppercase table-header-dark">
                            <tr>
                                <th scope="col" class="px-6 py-3 w-16">No.</th>
                                <th scope="col" class="px-6 py-3">Nama Santri</th>
                                <th scope="col" class="px-6 py-3 w-24">Nilai</th>
                            </tr>
                        </thead>
                        <tbody id="preview-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="p-6 bg-slate-50 border-t rounded-b-xl flex flex-col md:flex-row justify-end gap-4">
                <button id="cancel-btn" class="py-3 px-6 rounded-lg font-bold bg-white/10 text-white/80 hover:bg-white/20 transition-colors">
                    Kembali & Edit
                </button>
                <button id="confirm-submit-btn" class="btn btn-primary flex items-center justify-center gap-2">
                    <span id="submit-text">Konfirmasi & Kirim</span>
                    <span id="submit-spinner" class="hidden">
                        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification --><div id="toast" class="fixed top-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg transform translate-x-[120%] transition-transform duration-500 z-50"></div>

    <!-- Running Text Footer --><div class="running-text-container">
        <div class="running-text">
            <p>Setiap ketukan jari Ustadz dan Ustadzah hari ini, adalah investasi kita bersama untuk pemimpin masa depan. Terima kasih atas dedikasi tanpa batas #SalamKangenJalanJalanLagi 🛵 🛫 🚌 😎  &nbsp;&nbsp;&nbsp;&nbsp; Setiap ketukan jari Ustadz dan Ustadzah hari ini, adalah investasi kita bersama untuk pemimpin masa depan. Terima kasih atas dedikasi tanpa batas #SalamKangenJalanJalanLagi . &nbsp;&nbsp;&nbsp;&nbsp;</p>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- DATA ---
    const schoolData = {
        SMP: {
            classes: {
                'Kelas 7 A Putra': ["Athariz Chalief Saputra", "Ahmad Khomaini", "Al Athar Ghaizan Nobel", "Alzabar Akbar", "Arya Devano", "Abyan Dzaky Hafizh Kurniawan", "Fadil Syafif Nugroho Sukri", "Fakhri Muhammad Mumtaz", "I Komang Raditiya Novian Pradana Putra", "Ibad Najwan", "Ibni Shidqie Al Mumtazhar", "Kenzie Dastan Shalahuddin Zan", "Khaerul A'Zam Ismail", "Khairiy Rezki Adhinata", "Lionel Pratama Nugroho", "Mahfidz Ardiansyah", "Mohamad Akromul Azam", "Mohammad Ezra Rafiandhika", "Muhammad Akhtar Al Hisyam", "Muhammad Al Fatih", "Muhammad Fatir Albahri", "Muhammad Naufal Rizki", "Muhammad Syamil At Tsauri", "Nauval Abdul Rasyid", "Pranatantra Fachrie", "Rajata Ibnu Faqih", "Reygi Antajun Hikaru", "Rifqi Irfan Hamizan", "Umar Al Jailaani", "Yossa Dzulfi Andrean", "Zahran Sahil", "Rizky Setyo Nugroho", "Teuku Rizqi Mutha"],
                'Kelas 7 B Putra': ["Abidzar Nuha Wafi", "Ach. Raihan Faiz As-Sudaisyi", "Ahmad Nazmu Durori", "Akbar Nurfatah Arsadi", "Akhdan Athaya Putra Zulfikar", "Al Barra Ananta Putra", "Annabighoh Syabanu Gunawan", "Arrais Mahardika Rusli", "Athaya Kaysan Hakim", "Aufa Gilang Pratama", "Bilal Abdul Aslam", "Bintang Dasilva Ibrahim", "Brilliant Alziddan Mustofa", "Denny Maulana Yusuf", "Fathir Muhammad Fadhilah", "Haikal Ahfwan", "Harry Harsya Shiddiq", "Ifan Sofyan", "Kenzie Adelio Tristan", "Khairul Walif", "Luthfirrahman Nafis Hananto", "Muhammad Al-gaza Putra Dewian", "Muhammad Arafa Ekiyano Febrian", "Muhammad Dilfa Fattan", "Muhammad Fahriansyah", "Muhammad Fathan Toriq", "Muhammad Haikal Al Faisya", "Muhammad Najetullah", "Muhammad Raditya Fauzan", "Muhammad Waldan", "Rayhan Faiz Abdillah Hadiyanto", "Sultan Fatih Setiawan", "Zhafran Tata Hidayat"],
                'Kelas 7 A Putri': ["Adara Riyanti", "Aghniya Musamma Harahap", "Ahla Amany Maulidya", "Alivia Zahratukanza", "Alya Ruby Salimah", "Ameera Syahida Ajie", "Asyifa Mahira Lubis", "Bilqis Ghaisani Ahza", "Callysta Lareina Nabiha", "Cordelia Krisna Widyantari", "Deyanna Abigail Baligha Zephania", "Fathya Caliana", "Filzah Ghaisani Fikriyah", "Indhieswara Maharani", "Kanaya Athalla Dzakiyyah", "Kawa'Iba Puti Firmansyah", "Keisha Sahila Az Zahra", "Khansa Ghina Rachmani", "Mehira Mehrnaz Multazam", "Nadiya Fajria Salsabila", "Novilly Azwan", "Putri Mutia Rahmi", "Queenisa Yumna Zahirah", "Rita Madinatul Arofah", "Saffanah Saafia Zahirah", "Shelby Sinar Islamadina", "Shira Rizkia Adara", "Siti Shofa Aulia Rahman", "Syifa Anindya", "Talita Himayatul Kamilah", "Talita Khansa Saputra", "Yukqiu Natasha Ardi", "Zivana Lay"],
                'Kelas 7 B Putri': ["Aesha Bellvania Kirana", "Aira Fitriani Azzahra", "Aisyah Fahira Husna", "Alya Zahra Nabila", "Ameera Isnain Setiadi", "Aulia Zahra Ibrahim", "Azizahtun Nazwa", "Ghina Bilqis Shabreen", "Hafizhah Alimah", "Haninda Aulia Dayana", "Hilma Arifa Aulia Rosid", "Jihan Amira Karim", "Keyla Khanza Ramadhani", "Nafisa Al Mahira", "Nailatisya Aquina Salsabilla", "Nilam Maulina Anggraini", "R A Najeela Putri Widiarsa", "Rhaqueena Aleameccha Alingga", "Salsabila Zovanka", "Shakila Aulia Sakhiy", "Shifa Mumtazah", "Siti Alifia Zahra", "Siti Zahwa Naura Auni", "Siti Ziarra Nur Al-jaelani", "Syafa Savira", "Syakilah Putri Oktavia", "Syakirah Rizqia Ramadani", "Tuhfatun Najwa", "Vinca Fitranavira Putri", "Zhafira Nur Azzahra", "Tiara Izzatunnisa", "Kinara Rahmadania"],
            },
            subjects: ["Bahasa Indonesia", "PKn", "Bahasa Inggris", "Matematika", "IPA", "IPS", "Tahsin Tahfizh", "Muhadhoroh", "Tauhid", "Fiqih", "Tafsir", "Hadits", "Tarikh Islam", "Durusul Lughoh", "Mahfuzhot", "Tajwid", "Akhlak Lil Banin", "Muthola'ah", "Khat", "Imla"]
        },
        SMA: {
            classes: {
                'Kelas 10 Putra': ["Adhwa Arsya Gatfan", "Afa Zaidan Putra Tamba", "Ahmad Rafli Dhani Muzakki", "Akmal Ihsan Huwaidi", "Albisna Zinata Ababil", "Asyraf Fairuz Mumtaz", "Attiq Muzaki Ibrahim", "Bayanaca Qotthon Elbarca", "Bazyli Rafif Azka", "Charli Andestian", "Danendra Apta Kayana", "Dhafinzha Muhammad Fakhri", "Fasabbi Haqiqie Pramada Rozak", "Irsyad Haitami Fajrin", "Mikail Abdul Majid", "Mochammad Alfath Dhafin", "Muaimar Ghadafi M. Asri", "Muhamad Fairuz Azmi", "Muhamad Rafka Alvaro", "Muhammad Adil Shidqi", "Muhammad Agla Alfathur Rahman", "Muhammad Ammar Muzakki", "Muhammad Azmi", "Muhammad Fahri Alfarizi", "Muhammad Fahri Rosadi", "Muhammad Suryo Nugra Putra Anwar", "Nawwaf Bilza Pakpahan", "Raditya Bustanul Tamam", "Raihan Ramadhan", "Salim Al Habsyi", "Sayyid Aqil Sakhiy Wahyudi", "Yudha Pratama Nurwicaksana Nasution"],
                'Kelas 10 Putri': ["Alfina Dhiya Ulhaq", "Amelinda Nur Febrina", "Amira Azzarine", "Anjeli Ghenia Asmedi", "Aulia Zahra Nursakinah", "Callysta Zhahira", "Citra Aulia Saputra", "Egidhea Sakha Gendis", "Faiha Ulayya", "Kanaya Azzalea Maulida", "Kayla Putri Azzahra", "Kesya Anastasya Putri", "Keysha Hana Alzena", "Khansa Avicenna", "Maia Dina Islamiy Sobariah", "Nailah Saffanah Rizqin", "Najwa Althafunisa", "Nasya Adya Mustafidah", "Raihana Radwa Fahira", "Ratu Syahlina Samlawi", "Siti Aulia Rahma", "Syifa Az Zahra", "Tia Anggrianti", "Ussy Elsinasari", "Vicky Fadilah Luthfiyana", "Virly Evelyn Dean Zahra", "Wildatul Hasanah", "Yolanda Febriani", "Yuha Rizqiyatul Muyassaroh", "Zahiratul Aisyi", "Zulfa Nurul Fauziah"]
            },
            subjects: ["PKn", "Bahasa Indonesia", "Bahasa Inggris", "Matematika", "Biologi", "Fisika", "Kimia", "Ekonomi", "Geografi", "Sosiologi", "Sejarah", "Tahsin Tahfizh", "Muhadhoroh", "Tauhid", "Fiqih", "Tafsir", "Hadits", "Tarikh Islam", "Durusul Lughoh", "Ushul Fiqih", "Nahwu Shorof", "Mahfuzhot", "Khat", "Imla"]
        }
    };
    
    // --- PENTING: GANTI DENGAN URL DEPLOYMENT SCRIPT ANDA ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbydoOCTCTri8WEhT6RcbGQNxOQHrrIdmsad69SgbaNRMmtknygxetSSLYIFxsUrWkQz/exec"; 

    // --- DOM Elements ---
    const levelSelect = document.getElementById('school-level');
    const classSelect = document.getElementById('class-name');
    const subjectSelect = document.getElementById('subject');
    const startInputBtn = document.getElementById('start-input-btn');
    const selectionForm = document.getElementById('selection-form');
    const gradeInputSection = document.getElementById('grade-input-section');
    const gradeInputHeader = document.getElementById('grade-input-header');
    const studentListBody = document.getElementById('student-list-body');
    const changeSelectionBtn = document.getElementById('change-selection-btn');
    const previewBtn = document.getElementById('preview-btn');
    const modal = document.getElementById('preview-modal');
    const confirmSubmitBtn = document.getElementById('confirm-submit-btn');

    // --- Functions ---
    function updateDropdowns() {
        const level = levelSelect.value;
        classSelect.innerHTML = '<option value="">Pilih Kelas...</option>';
        subjectSelect.innerHTML = '<option value="">Pilih Mapel...</option>';
        
        if (level) {
            const data = schoolData[level];
            Object.keys(data.classes).sort().forEach(className => {
                classSelect.add(new Option(className, className));
            });
            data.subjects.sort().forEach(subject => {
                subjectSelect.add(new Option(subject, subject));
            });
            classSelect.disabled = false;
            subjectSelect.disabled = false;
        } else {
            classSelect.disabled = true;
            subjectSelect.disabled = true;
        }
        validateSelections();
    }

    function validateSelections() {
        startInputBtn.disabled = !(levelSelect.value && classSelect.value && subjectSelect.value);
    }
    
    function startGradeInput() {
        const level = levelSelect.value;
        const className = classSelect.value;
        const subject = subjectSelect.value;

        if (!level || !className || !subject) return;

        gradeInputHeader.textContent = `Kelas: ${className} | Mapel: ${subject}`;
        
        const students = schoolData[level].classes[className];
        studentListBody.innerHTML = '';
        students.forEach((student, index) => {
            const row = document.createElement('tr');
            row.className = 'table-row-dark';
            row.innerHTML = `
                <td class="px-6 py-4 font-medium text-white/90">${index + 1}</td>
                <td class="px-6 py-4 student-name">${student}</td>
                <td class="px-6 py-4">
                    <input type="text" class="grade-input w-full p-2 border rounded-md text-center" placeholder="10-100 atau -">
                </td>
            `;
            studentListBody.appendChild(row);
        });
        
        selectionForm.classList.add('hidden');
        gradeInputSection.classList.remove('hidden');
    }

    function resetToSelection() {
        gradeInputSection.classList.add('hidden');
        selectionForm.classList.remove('hidden');
        levelSelect.value = '';
        updateDropdowns();
    }
    
    function showPreview() {
        const grades = [];
        let allInputsValid = true;

        document.querySelectorAll('#student-list-body tr').forEach(row => {
            const name = row.querySelector('.student-name').textContent;
            const input = row.querySelector('.grade-input');
            const value = input.value.trim();
            
            const isHyphen = value === '-';
            const isNumeric = !isNaN(value) && value !== ''; // Check numeric and not empty
            const isNumericValid = isNumeric && Number(value) >= 10 && Number(value) <= 100;

            if (isHyphen || isNumericValid) {
                input.style.borderColor = '';
                input.classList.remove('border-red-500', 'ring-2', 'ring-red-500');
            } else {
                allInputsValid = false;
                input.classList.add('border-red-500', 'ring-2', 'ring-red-500');
            }
            grades.push({ name, value: value === '' ? 'BELUM DIISI' : value });
        });

        if (!allInputsValid) {
            showToast('Harap isi semua nilai dengan angka 10-100, atau tanda (-).', 'error');
            return;
        }

        document.getElementById('preview-details').innerHTML = `
            <p><span class="font-semibold w-32 inline-block">Jenjang</span>: ${levelSelect.value}</p>
            <p><span class="font-semibold w-32 inline-block">Kelas</span>: ${classSelect.value}</p>
            <p><span class="font-semibold w-32 inline-block">Mata Pelajaran</span>: ${subjectSelect.value}</p>
        `;
        
        const previewTableBody = document.getElementById('preview-table-body');
        previewTableBody.innerHTML = '';
        grades.forEach((grade, index) => {
             previewTableBody.innerHTML += `
                <tr class="table-row-dark">
                    <td class="px-6 py-4 font-medium text-white/90">${index + 1}</td>
                    <td class="px-6 py-4">${grade.name}</td>
                    <td class="px-6 py-4 font-semibold text-white text-center">${grade.value}</td>
                </tr>
             `;
        });
        
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setTimeout(() => modal.querySelector('.bg-white').classList.remove('scale-95', 'opacity-0'), 10);
    }
    
    function closeModal() {
        const modalContent = modal.querySelector('.bg-white');
        modalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    async function submitData() {
        if (!SCRIPT_URL || SCRIPT_URL === "GANTI_DENGAN_URL_SCRIPT_ANDA_DISINI") {
            showToast("URL Google Apps Script belum diatur!", 'error');
            return;
        }
        
        const payload = {
            className: classSelect.value,
            subject: subjectSelect.value,
            grades: Array.from(document.querySelectorAll('#student-list-body tr')).map(row => ({
                studentName: row.querySelector('.student-name').textContent,
                grade: row.querySelector('.grade-input').value
            }))
        };
        
        setLoadingState(true);
        closeModal();
        resetToSelection();
        showToast('Mengirim data nilai ke spreadsheet...', 'info');

        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (result.result !== 'success') throw new Error(result.message);
            showToast('Nilai berhasil dikirim!');
        } catch (error) {
            showToast(`Gagal mengirim: ${error.message}`, 'error');
        } finally {
             setLoadingState(false);
        }
    }

    function setLoadingState(isLoading) {
        confirmSubmitBtn.disabled = isLoading;
        document.getElementById('submit-text').classList.toggle('hidden', isLoading);
        document.getElementById('submit-spinner').classList.toggle('hidden', !isLoading);
    }

    let toastTimeout;
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        clearTimeout(toastTimeout);
        toast.textContent = message;
        toast.className = 'fixed top-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg transform transition-transform duration-500 z-50';
        
        if (type === 'error') toast.classList.add('bg-red-500');
        else if (type === 'info') toast.classList.add('bg-blue-500');
        else toast.classList.add('bg-green-500');
        
        toast.classList.remove('translate-x-[120%]');
        toastTimeout = setTimeout(() => toast.classList.add('translate-x-[120%]'), 4000);
    }

    // --- Event Listeners ---
    levelSelect.addEventListener('change', updateDropdowns);
    classSelect.addEventListener('change', validateSelections);
    subjectSelect.addEventListener('change', validateSelections);
    startInputBtn.addEventListener('click', startGradeInput);
    changeSelectionBtn.addEventListener('click', resetToSelection);
    previewBtn.addEventListener('click', showPreview);
    
    document.getElementById('close-modal-btn').addEventListener('click', closeModal);
    document.getElementById('cancel-btn').addEventListener('click', closeModal);
    confirmSubmitBtn.addEventListener('click', submitData);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
});
</script>
</body>
</html>

